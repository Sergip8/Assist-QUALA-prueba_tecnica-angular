<div class="dynamic-form-container">
  <!-- Header -->
  <div class="form-header" *ngIf="config?.title || config?.subtitle">
    <h2 *ngIf="config.title" class="form-title">{{ config.title }}</h2>
    <p *ngIf="config.subtitle" class="form-subtitle">{{ config.subtitle }}</p>
  </div>

  <!-- Form -->
  <form [formGroup]="form" (ngSubmit)="handleSubmit()" class="dynamic-form" [ngClass]="{'dynamic-form-modal': inModal}">
    <div class="form-fields">
      <ng-container *ngFor="let field of config?.fields">
        
        <!-- Text, Email, Password, Number, Tel, URL -->
        <nz-form-item class="input-label" *ngIf="['text', 'email', 'password', 'number', 'tel', 'url'].includes(field.type)">
          <nz-form-label [nzRequired]="field.required">{{ field.label }}</nz-form-label>
          <nz-form-control [nzErrorTip]="getFieldError(field.name)">
            <input 
              nz-input
              [type]="field.type"
              [placeholder]="field.placeholder || ''"
              [formControlName]="field.name"
              [class.error]="isFieldInvalid(field.name)"
              class="ant-input"
            />
          </nz-form-control>
        </nz-form-item>

        <!-- Textarea -->
        <nz-form-item class="input-label" *ngIf="field.type === 'textarea'">
          <nz-form-label [nzRequired]="field.required">{{ field.label }}</nz-form-label>
          <nz-form-control [nzErrorTip]="getFieldError(field.name)">
            <textarea 
              nz-input
              [placeholder]="field.placeholder || ''"
              [formControlName]="field.name"
              [rows]="field.rows || 3"
              [class.error]="isFieldInvalid(field.name)"
              class="ant-input"
            ></textarea>
          </nz-form-control>
        </nz-form-item>

        <!-- Select -->
        <nz-form-item class="input-label" *ngIf="field.type === 'select'">
          <nz-form-label [nzRequired]="field.required">{{ field.label }}</nz-form-label>
          <nz-form-control [nzErrorTip]="getFieldError(field.name)">
            <nz-select 
              [formControlName]="field.name"
              [nzPlaceHolder]="field.placeholder || 'Seleccione una opciÃ³n'"
              [class.error]="isFieldInvalid(field.name)"
              class="ant-input"
            >
              <nz-option 
                *ngFor="let option of field.options" 
                [nzValue]="option.value" 
                [nzLabel]="option.label"
              ></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <!-- Radio -->
        <nz-form-item *ngIf="field.type === 'radio'">
          <nz-form-label [nzRequired]="field.required">{{ field.label }}</nz-form-label>
          <nz-form-control [nzErrorTip]="getFieldError(field.name)">
            <nz-radio-group [formControlName]="field.name">
              <label 
                *ngFor="let option of field.options" 
                nz-radio 
                [nzValue]="option.value"
              >
                {{ option.label }}
              </label>
            </nz-radio-group>
          </nz-form-control>
        </nz-form-item>

        <!-- Checkbox -->
        <nz-form-item *ngIf="field.type === 'checkbox'">
          <nz-form-control [nzErrorTip]="getFieldError(field.name)">
            <label nz-checkbox [formControlName]="field.name">
              {{ field.label }}
            </label>
          </nz-form-control>
        </nz-form-item>

        <!-- Date -->
        <nz-form-item *ngIf="field.type === 'date'">
          <nz-form-label [nzRequired]="field.required">{{ field.label }}</nz-form-label>
          <nz-form-control [nzErrorTip]="getFieldError(field.name)">
            <nz-date-picker 
              [formControlName]="field.name"
              [nzPlaceHolder]="field.placeholder || 'Seleccione fecha'"
              [class.error]="isFieldInvalid(field.name)"
              style="width: 100%"
            ></nz-date-picker>
          </nz-form-control>
        </nz-form-item>

        <!-- DateTime Local -->
        <nz-form-item *ngIf="field.type === 'datetime-local'">
          <nz-form-label [nzRequired]="field.required">{{ field.label }}</nz-form-label>
          <nz-form-control [nzErrorTip]="getFieldError(field.name)">
            <nz-date-picker 
              [formControlName]="field.name"
              [nzPlaceHolder]="field.placeholder || 'Seleccione fecha y hora'"
              [nzShowTime]="true"
              [class.error]="isFieldInvalid(field.name)"
              style="width: 100%"
            ></nz-date-picker>
          </nz-form-control>
        </nz-form-item>

        <!-- Search with API -->
        <nz-form-item class="input-label" *ngIf="field.type === 'search' && field.searchConfig">
          <nz-form-label [nzRequired]="field.required">{{ field.label }}</nz-form-label>
          <nz-form-control [nzErrorTip]="getFieldError(field.name)">
            <div class="search-container">
              <nz-input-group >
              <input 
  nz-input 
  [formControlName]="field.name"
  [placeholder]="field.placeholder || 'Buscar...'" 
  (input)="onSearchInput(field.name, inputRef.value)" 
  [class.error]="isFieldInvalid(field.name)" 
  class="ant-input"
  #inputRef 
/>

              </nz-input-group>
              <ng-template #suffixTemplate>
                <nz-spin *ngIf="searchLoading[field.name]" nzSize="small"></nz-spin>
                <i nz-icon nzType="search" *ngIf="!searchLoading[field.name]"></i>
              </ng-template>
<div *ngIf="labelSelected">
<span>{{labelSelected[field.name]}} </span>
</div>
              <!-- Search Results -->
              <div class="search-results" *ngIf="(searchResults[field.name]).length > 0">
                <a 
                  class="search-result-item"
                  *ngFor="let item of searchResults[field.name]"
                  (mousedown)="onSearchSelect(field.name, item)"
                >
                  {{ item[field.searchConfig!.labelKey] }}
              </a>
            </div>
            </div>
          </nz-form-control>
        </nz-form-item>

      </ng-container>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button 
        *ngIf="config?.showCancelButton"
        nz-button 
        type="button"
        class="cancel-btn"
        (click)="handleCancel()"
      >
        {{ config.cancelButtonText || 'Cancelar' }}
      </button>
      
      <button 
        nz-button 
        nzType="primary" 
        type="submit"
        class="submit-btn"
        [nzLoading]="form?.pending"
      >
        {{ config.submitButtonText || 'Guardar' }}
      </button>
    </div>
  </form>
</div>